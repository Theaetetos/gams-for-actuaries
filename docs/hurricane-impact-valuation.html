<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 3 Hurricane Impact Valuation | Generalized Additive Models for Actuaries</title>
  <meta name="description" content="An Introduction to Generalized Additive Models for Health Actuarial Business Problems." />
  <meta name="generator" content="bookdown 0.33 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 3 Hurricane Impact Valuation | Generalized Additive Models for Actuaries" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="An Introduction to Generalized Additive Models for Health Actuarial Business Problems." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 3 Hurricane Impact Valuation | Generalized Additive Models for Actuaries" />
  
  <meta name="twitter:description" content="An Introduction to Generalized Additive Models for Health Actuarial Business Problems." />
  

<meta name="author" content="Nathan Cornwell" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="utilization-forecasting.html"/>
<link rel="next" href="valuation-of-care-interventions.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">A Minimal Bookdown Book</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Introduction</a>
<ul>
<li class="chapter" data-level="0.1" data-path="index.html"><a href="index.html#our-workspace"><i class="fa fa-check"></i><b>0.1</b> Our Workspace</a></li>
<li class="chapter" data-level="0.2" data-path="index.html"><a href="index.html#preliminaries"><i class="fa fa-check"></i><b>0.2</b> Preliminaries</a>
<ul>
<li class="chapter" data-level="0.2.1" data-path="index.html"><a href="index.html#branding-code"><i class="fa fa-check"></i><b>0.2.1</b> Branding Code</a></li>
<li class="chapter" data-level="0.2.2" data-path="index.html"><a href="index.html#packages"><i class="fa fa-check"></i><b>0.2.2</b> Packages</a></li>
<li class="chapter" data-level="0.2.3" data-path="index.html"><a href="index.html#some-of-our-datasets"><i class="fa fa-check"></i><b>0.2.3</b> (Some of our) Datasets</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="1" data-path="motivating-gams.html"><a href="motivating-gams.html"><i class="fa fa-check"></i><b>1</b> Motivating GAMs</a>
<ul>
<li class="chapter" data-level="1.1" data-path="motivating-gams.html"><a href="motivating-gams.html#linear-regression"><i class="fa fa-check"></i><b>1.1</b> Linear Regression</a></li>
<li class="chapter" data-level="1.2" data-path="motivating-gams.html"><a href="motivating-gams.html#data"><i class="fa fa-check"></i><b>1.2</b> Data</a></li>
<li class="chapter" data-level="1.3" data-path="motivating-gams.html"><a href="motivating-gams.html#model-fitting"><i class="fa fa-check"></i><b>1.3</b> Model Fitting</a></li>
<li class="chapter" data-level="1.4" data-path="motivating-gams.html"><a href="motivating-gams.html#generalized-linear-models"><i class="fa fa-check"></i><b>1.4</b> Generalized Linear Models</a></li>
<li class="chapter" data-level="1.5" data-path="motivating-gams.html"><a href="motivating-gams.html#generalized-additive-models"><i class="fa fa-check"></i><b>1.5</b> Generalized Additive Models</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="utilization-forecasting.html"><a href="utilization-forecasting.html"><i class="fa fa-check"></i><b>2</b> Utilization Forecasting</a>
<ul>
<li class="chapter" data-level="2.1" data-path="utilization-forecasting.html"><a href="utilization-forecasting.html#introduction-1"><i class="fa fa-check"></i><b>2.1</b> Introduction</a></li>
<li class="chapter" data-level="2.2" data-path="utilization-forecasting.html"><a href="utilization-forecasting.html#data-1"><i class="fa fa-check"></i><b>2.2</b> Data</a></li>
<li class="chapter" data-level="2.3" data-path="utilization-forecasting.html"><a href="utilization-forecasting.html#predictors"><i class="fa fa-check"></i><b>2.3</b> Predictors</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="utilization-forecasting.html"><a href="utilization-forecasting.html#weekday"><i class="fa fa-check"></i><b>2.3.1</b> Weekday</a></li>
<li class="chapter" data-level="2.3.2" data-path="utilization-forecasting.html"><a href="utilization-forecasting.html#in-year"><i class="fa fa-check"></i><b>2.3.2</b> In-year</a></li>
<li class="chapter" data-level="2.3.3" data-path="utilization-forecasting.html"><a href="utilization-forecasting.html#holidays"><i class="fa fa-check"></i><b>2.3.3</b> Holidays</a></li>
<li class="chapter" data-level="2.3.4" data-path="utilization-forecasting.html"><a href="utilization-forecasting.html#covid"><i class="fa fa-check"></i><b>2.3.4</b> COVID</a></li>
<li class="chapter" data-level="2.3.5" data-path="utilization-forecasting.html"><a href="utilization-forecasting.html#trend"><i class="fa fa-check"></i><b>2.3.5</b> Trend</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="utilization-forecasting.html"><a href="utilization-forecasting.html#model-fitting-1"><i class="fa fa-check"></i><b>2.4</b> Model Fitting</a></li>
<li class="chapter" data-level="2.5" data-path="utilization-forecasting.html"><a href="utilization-forecasting.html#making-predictions"><i class="fa fa-check"></i><b>2.5</b> Making Predictions</a></li>
<li class="chapter" data-level="2.6" data-path="utilization-forecasting.html"><a href="utilization-forecasting.html#alternative-trend-forecast"><i class="fa fa-check"></i><b>2.6</b> Alternative Trend Forecast</a>
<ul>
<li class="chapter" data-level="2.6.1" data-path="utilization-forecasting.html"><a href="utilization-forecasting.html#model-fitting-2"><i class="fa fa-check"></i><b>2.6.1</b> Model Fitting</a></li>
<li class="chapter" data-level="2.6.2" data-path="utilization-forecasting.html"><a href="utilization-forecasting.html#making-predictions-1"><i class="fa fa-check"></i><b>2.6.2</b> Making Predictions</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="hurricane-impact-valuation.html"><a href="hurricane-impact-valuation.html"><i class="fa fa-check"></i><b>3</b> Hurricane Impact Valuation</a>
<ul>
<li class="chapter" data-level="3.1" data-path="hurricane-impact-valuation.html"><a href="hurricane-impact-valuation.html#introduction-2"><i class="fa fa-check"></i><b>3.1</b> Introduction</a></li>
<li class="chapter" data-level="3.2" data-path="hurricane-impact-valuation.html"><a href="hurricane-impact-valuation.html#data-2"><i class="fa fa-check"></i><b>3.2</b> Data</a></li>
<li class="chapter" data-level="3.3" data-path="hurricane-impact-valuation.html"><a href="hurricane-impact-valuation.html#model-fitting-3"><i class="fa fa-check"></i><b>3.3</b> Model Fitting</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="hurricane-impact-valuation.html"><a href="hurricane-impact-valuation.html#initial-model"><i class="fa fa-check"></i><b>3.3.1</b> Initial Model</a></li>
<li class="chapter" data-level="3.3.2" data-path="hurricane-impact-valuation.html"><a href="hurricane-impact-valuation.html#deriving-the-holiday-list"><i class="fa fa-check"></i><b>3.3.2</b> Deriving the Holiday List</a></li>
<li class="chapter" data-level="3.3.3" data-path="hurricane-impact-valuation.html"><a href="hurricane-impact-valuation.html#hurricane-effect-window"><i class="fa fa-check"></i><b>3.3.3</b> Hurricane Effect Window</a></li>
<li class="chapter" data-level="3.3.4" data-path="hurricane-impact-valuation.html"><a href="hurricane-impact-valuation.html#penultimate-model"><i class="fa fa-check"></i><b>3.3.4</b> Penultimate Model</a></li>
<li class="chapter" data-level="3.3.5" data-path="hurricane-impact-valuation.html"><a href="hurricane-impact-valuation.html#serial-autocorrelation-of-errors"><i class="fa fa-check"></i><b>3.3.5</b> Serial Autocorrelation of Errors</a></li>
<li class="chapter" data-level="3.3.6" data-path="hurricane-impact-valuation.html"><a href="hurricane-impact-valuation.html#heteroskedasticity"><i class="fa fa-check"></i><b>3.3.6</b> Heteroskedasticity</a></li>
<li class="chapter" data-level="3.3.7" data-path="hurricane-impact-valuation.html"><a href="hurricane-impact-valuation.html#final-model"><i class="fa fa-check"></i><b>3.3.7</b> Final Model</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="hurricane-impact-valuation.html"><a href="hurricane-impact-valuation.html#using-the-model"><i class="fa fa-check"></i><b>3.4</b> Using the Model</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="valuation-of-care-interventions.html"><a href="valuation-of-care-interventions.html"><i class="fa fa-check"></i><b>4</b> Valuation of Care Interventions</a>
<ul>
<li class="chapter" data-level="4.1" data-path="valuation-of-care-interventions.html"><a href="valuation-of-care-interventions.html#introduction-3"><i class="fa fa-check"></i><b>4.1</b> Introduction</a></li>
<li class="chapter" data-level="4.2" data-path="valuation-of-care-interventions.html"><a href="valuation-of-care-interventions.html#data-3"><i class="fa fa-check"></i><b>4.2</b> Data</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="valuation-of-care-interventions.html"><a href="valuation-of-care-interventions.html#processed-dataset"><i class="fa fa-check"></i><b>4.2.1</b> Processed Dataset</a></li>
<li class="chapter" data-level="4.2.2" data-path="valuation-of-care-interventions.html"><a href="valuation-of-care-interventions.html#exposure"><i class="fa fa-check"></i><b>4.2.2</b> Exposure</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="valuation-of-care-interventions.html"><a href="valuation-of-care-interventions.html#model-fitting-4"><i class="fa fa-check"></i><b>4.3</b> Model Fitting</a></li>
<li class="chapter" data-level="4.4" data-path="valuation-of-care-interventions.html"><a href="valuation-of-care-interventions.html#using-the-model-1"><i class="fa fa-check"></i><b>4.4</b> Using the Model</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Generalized Additive Models for Actuaries</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="hurricane-impact-valuation" class="section level1 hasAnchor" number="3">
<h1><span class="header-section-number">Chapter 3</span> Hurricane Impact Valuation<a href="hurricane-impact-valuation.html#hurricane-impact-valuation" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="introduction-2" class="section level2 hasAnchor" number="3.1">
<h2><span class="header-section-number">3.1</span> Introduction<a href="hurricane-impact-valuation.html#introduction-2" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Another very similar way I use GAMs is to value utilization impacts caused by storms.
The main impacts a health insurer sees from something like a hurricane is a slowdown in utilization from the danger and difficulty traveling caused by the storm.
We can adapt the tools we already have from the previous chapter and add things in order to strengthen our model to be able to use it for hyptothesis testing and quantification.
In order to model the hurricane’s effects as rigorously as possible, we need to do some more thorough model validation so we can make sound statistical deductions from it.</p>
</div>
<div id="data-2" class="section level2 hasAnchor" number="3.2">
<h2><span class="header-section-number">3.2</span> Data<a href="hurricane-impact-valuation.html#data-2" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The data this time is utilization for a random set of services for UHC’s commercial fully-insured book of business in Texas.</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="hurricane-impact-valuation.html#cb54-1" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">fread</span>(</span>
<span id="cb54-2"><a href="hurricane-impact-valuation.html#cb54-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="fu">file.path</span>(<span class="st">&#39;data&#39;</span>, <span class="st">&#39;hurr_data.csv&#39;</span>),</span>
<span id="cb54-3"><a href="hurricane-impact-valuation.html#cb54-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">colClasses =</span> <span class="fu">c</span>(<span class="at">ds =</span> <span class="st">&#39;Date&#39;</span>)</span>
<span id="cb54-4"><a href="hurricane-impact-valuation.html#cb54-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb54-5"><a href="hurricane-impact-valuation.html#cb54-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-6"><a href="hurricane-impact-valuation.html#cb54-6" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dat) <span class="sc">+</span></span>
<span id="cb54-7"><a href="hurricane-impact-valuation.html#cb54-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(ds, y)) <span class="sc">+</span></span>
<span id="cb54-8"><a href="hurricane-impact-valuation.html#cb54-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb54-9"><a href="hurricane-impact-valuation.html#cb54-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb54-10"><a href="hurricane-impact-valuation.html#cb54-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">&#39;Utilization&#39;</span></span>
<span id="cb54-11"><a href="hurricane-impact-valuation.html#cb54-11" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb54-12"><a href="hurricane-impact-valuation.html#cb54-12" aria-hidden="true" tabindex="-1"></a>  mytheme</span></code></pre></div>
<p><img src="gams-for-actuaries_files/figure-html/unnamed-chunk-48-1.png" width="672" /></p>
<p>The COVID slowdown is also clearly visible. Note also that this data has runout effects at the end of the training period, i.e. the most recent time periods have had less times for claims to process.</p>
<p>As you may remember, Texas was hit by the historic Hurricane Harvey in 2017.</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="hurricane-impact-valuation.html#cb55-1" aria-hidden="true" tabindex="-1"></a>landfall <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(<span class="st">&#39;2017-8-25&#39;</span>)</span>
<span id="cb55-2"><a href="hurricane-impact-valuation.html#cb55-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-3"><a href="hurricane-impact-valuation.html#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dat) <span class="sc">+</span></span>
<span id="cb55-4"><a href="hurricane-impact-valuation.html#cb55-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(</span>
<span id="cb55-5"><a href="hurricane-impact-valuation.html#cb55-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">xintercept =</span> landfall,</span>
<span id="cb55-6"><a href="hurricane-impact-valuation.html#cb55-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> colors<span class="sc">$</span>Visualization<span class="sc">$</span>Lagoon,</span>
<span id="cb55-7"><a href="hurricane-impact-valuation.html#cb55-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">linetype =</span> <span class="st">&#39;dashed&#39;</span></span>
<span id="cb55-8"><a href="hurricane-impact-valuation.html#cb55-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb55-9"><a href="hurricane-impact-valuation.html#cb55-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(ds, y)) <span class="sc">+</span></span>
<span id="cb55-10"><a href="hurricane-impact-valuation.html#cb55-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">as.Date</span>(<span class="fu">c</span>(<span class="st">&#39;2017-8-1&#39;</span>, <span class="st">&#39;2017-9-30&#39;</span>))) <span class="sc">+</span></span>
<span id="cb55-11"><a href="hurricane-impact-valuation.html#cb55-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb55-12"><a href="hurricane-impact-valuation.html#cb55-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb55-13"><a href="hurricane-impact-valuation.html#cb55-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">&#39;Utilization&#39;</span></span>
<span id="cb55-14"><a href="hurricane-impact-valuation.html#cb55-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb55-15"><a href="hurricane-impact-valuation.html#cb55-15" aria-hidden="true" tabindex="-1"></a>  mytheme</span></code></pre></div>
<p><img src="gams-for-actuaries_files/figure-html/unnamed-chunk-49-1.png" width="672" /></p>
<p>Now we add the date variables we’ve been discussing.
We will use an initial holiday list and iteratively improve it.
For the COVID term, we will just use the parameters I’ve already determined at work to make the example shorter.
In a real modeling context, you would determine the width of the COVID window and the optimal smooth parameters using the same methods we will employ to create the hurricane term.</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="hurricane-impact-valuation.html#cb56-1" aria-hidden="true" tabindex="-1"></a>dat[</span>
<span id="cb56-2"><a href="hurricane-impact-valuation.html#cb56-2" aria-hidden="true" tabindex="-1"></a>  ,</span>
<span id="cb56-3"><a href="hurricane-impact-valuation.html#cb56-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb56-4"><a href="hurricane-impact-valuation.html#cb56-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">t =</span> .I,</span>
<span id="cb56-5"><a href="hurricane-impact-valuation.html#cb56-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">yr =</span> <span class="fu">year</span>(ds),</span>
<span id="cb56-6"><a href="hurricane-impact-valuation.html#cb56-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">yrfrac =</span> <span class="fu">as.numeric</span>(<span class="fu">strftime</span>(ds, <span class="st">&#39;%j&#39;</span>)),</span>
<span id="cb56-7"><a href="hurricane-impact-valuation.html#cb56-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">covid =</span> 0L,</span>
<span id="cb56-8"><a href="hurricane-impact-valuation.html#cb56-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">wkdy =</span> <span class="fu">factor</span>(</span>
<span id="cb56-9"><a href="hurricane-impact-valuation.html#cb56-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">strftime</span>(ds, <span class="st">&#39;%u&#39;</span>),</span>
<span id="cb56-10"><a href="hurricane-impact-valuation.html#cb56-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&#39;M&#39;</span>, <span class="st">&#39;T&#39;</span>, <span class="st">&#39;W&#39;</span> ,<span class="st">&#39;Tr&#39;</span>, <span class="st">&#39;F&#39;</span>, <span class="st">&#39;Sat&#39;</span>, <span class="st">&#39;Sun&#39;</span>)</span>
<span id="cb56-11"><a href="hurricane-impact-valuation.html#cb56-11" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb56-12"><a href="hurricane-impact-valuation.html#cb56-12" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb56-13"><a href="hurricane-impact-valuation.html#cb56-13" aria-hidden="true" tabindex="-1"></a>][</span>
<span id="cb56-14"><a href="hurricane-impact-valuation.html#cb56-14" aria-hidden="true" tabindex="-1"></a>  ,</span>
<span id="cb56-15"><a href="hurricane-impact-valuation.html#cb56-15" aria-hidden="true" tabindex="-1"></a>  yrfrac <span class="sc">:</span><span class="er">=</span> yrfrac <span class="sc">/</span> <span class="fu">max</span>(yrfrac),</span>
<span id="cb56-16"><a href="hurricane-impact-valuation.html#cb56-16" aria-hidden="true" tabindex="-1"></a>  by <span class="ot">=</span> .(yr)</span>
<span id="cb56-17"><a href="hurricane-impact-valuation.html#cb56-17" aria-hidden="true" tabindex="-1"></a>][</span>
<span id="cb56-18"><a href="hurricane-impact-valuation.html#cb56-18" aria-hidden="true" tabindex="-1"></a>  .(<span class="fu">seq</span>(<span class="at">from =</span> <span class="fu">as.Date</span>(<span class="st">&#39;2020-3-1&#39;</span>), <span class="at">length.out =</span> <span class="dv">122</span>, <span class="at">by =</span> <span class="dv">1</span>)),</span>
<span id="cb56-19"><a href="hurricane-impact-valuation.html#cb56-19" aria-hidden="true" tabindex="-1"></a>  covid <span class="sc">:</span><span class="er">=</span> .I,</span>
<span id="cb56-20"><a href="hurricane-impact-valuation.html#cb56-20" aria-hidden="true" tabindex="-1"></a>  on <span class="ot">=</span> <span class="st">&#39;ds&#39;</span></span>
<span id="cb56-21"><a href="hurricane-impact-valuation.html#cb56-21" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb56-22"><a href="hurricane-impact-valuation.html#cb56-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-23"><a href="hurricane-impact-valuation.html#cb56-23" aria-hidden="true" tabindex="-1"></a>hols_st <span class="ot">&lt;-</span> <span class="fu">fread</span>(</span>
<span id="cb56-24"><a href="hurricane-impact-valuation.html#cb56-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="fu">file.path</span>(<span class="st">&#39;data&#39;</span>, <span class="st">&#39;hols_st.csv&#39;</span>),</span>
<span id="cb56-25"><a href="hurricane-impact-valuation.html#cb56-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">colClasses =</span> <span class="fu">c</span>(<span class="at">ds =</span> <span class="st">&#39;Date&#39;</span>)</span>
<span id="cb56-26"><a href="hurricane-impact-valuation.html#cb56-26" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb56-27"><a href="hurricane-impact-valuation.html#cb56-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-28"><a href="hurricane-impact-valuation.html#cb56-28" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> hols_st[</span>
<span id="cb56-29"><a href="hurricane-impact-valuation.html#cb56-29" aria-hidden="true" tabindex="-1"></a>  dat,</span>
<span id="cb56-30"><a href="hurricane-impact-valuation.html#cb56-30" aria-hidden="true" tabindex="-1"></a>  on <span class="ot">=</span> <span class="st">&#39;ds&#39;</span></span>
<span id="cb56-31"><a href="hurricane-impact-valuation.html#cb56-31" aria-hidden="true" tabindex="-1"></a>][</span>
<span id="cb56-32"><a href="hurricane-impact-valuation.html#cb56-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">is.na</span>(hol),</span>
<span id="cb56-33"><a href="hurricane-impact-valuation.html#cb56-33" aria-hidden="true" tabindex="-1"></a>  hol <span class="sc">:</span><span class="er">=</span> <span class="st">&#39;none&#39;</span></span>
<span id="cb56-34"><a href="hurricane-impact-valuation.html#cb56-34" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb56-35"><a href="hurricane-impact-valuation.html#cb56-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-36"><a href="hurricane-impact-valuation.html#cb56-36" aria-hidden="true" tabindex="-1"></a><span class="fu">setkey</span>(dat, ds)</span></code></pre></div>
</div>
<div id="model-fitting-3" class="section level2 hasAnchor" number="3.3">
<h2><span class="header-section-number">3.3</span> Model Fitting<a href="hurricane-impact-valuation.html#model-fitting-3" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="initial-model" class="section level3 hasAnchor" number="3.3.1">
<h3><span class="header-section-number">3.3.1</span> Initial Model<a href="hurricane-impact-valuation.html#initial-model" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>To start with, we can fit an initial model that’s basically the same as the forecasting model we were working with in the prior chapter.
I like to account for runout by setting more knot points for the trend component to allow it to capture the sharp drop in claims.</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="hurricane-impact-valuation.html#cb57-1" aria-hidden="true" tabindex="-1"></a>ts <span class="ot">&lt;-</span> dat[</span>
<span id="cb57-2"><a href="hurricane-impact-valuation.html#cb57-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mday</span>(ds) <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span></span>
<span id="cb57-3"><a href="hurricane-impact-valuation.html#cb57-3" aria-hidden="true" tabindex="-1"></a>    (<span class="fu">month</span>(ds) <span class="sc">==</span> <span class="dv">1</span> <span class="sc">|</span> ds <span class="sc">&gt;</span> <span class="fu">as.Date</span>(<span class="st">&#39;2021-6-30&#39;</span>)),</span>
<span id="cb57-4"><a href="hurricane-impact-valuation.html#cb57-4" aria-hidden="true" tabindex="-1"></a>  t</span>
<span id="cb57-5"><a href="hurricane-impact-valuation.html#cb57-5" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb57-6"><a href="hurricane-impact-valuation.html#cb57-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-7"><a href="hurricane-impact-valuation.html#cb57-7" aria-hidden="true" tabindex="-1"></a>m_init <span class="ot">&lt;-</span> <span class="fu">gam</span>(</span>
<span id="cb57-8"><a href="hurricane-impact-valuation.html#cb57-8" aria-hidden="true" tabindex="-1"></a>  y <span class="sc">~</span> <span class="fu">s</span>(t) <span class="sc">+</span> <span class="fu">s</span>(yrfrac) <span class="sc">+</span> <span class="fu">s</span>(covid, <span class="at">k =</span> <span class="dv">122</span> <span class="sc">/</span> <span class="dv">7</span>) <span class="sc">+</span> wkdy <span class="sc">+</span> hol,</span>
<span id="cb57-9"><a href="hurricane-impact-valuation.html#cb57-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="fu">gaussian</span>(<span class="at">link =</span> <span class="st">&#39;log&#39;</span>),</span>
<span id="cb57-10"><a href="hurricane-impact-valuation.html#cb57-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> dat,</span>
<span id="cb57-11"><a href="hurricane-impact-valuation.html#cb57-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">knots =</span> <span class="fu">list</span>(<span class="at">t =</span> ts)</span>
<span id="cb57-12"><a href="hurricane-impact-valuation.html#cb57-12" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## Warning in mgcv::s(covid, k = 122/7): argument k of s() should be integer
## and has been rounded</code></pre>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="hurricane-impact-valuation.html#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(m_init, <span class="at">pages =</span> <span class="dv">1</span>)</span></code></pre></div>
<p><img src="gams-for-actuaries_files/figure-html/unnamed-chunk-51-1.png" width="672" /></p>
</div>
<div id="deriving-the-holiday-list" class="section level3 hasAnchor" number="3.3.2">
<h3><span class="header-section-number">3.3.2</span> Deriving the Holiday List<a href="hurricane-impact-valuation.html#deriving-the-holiday-list" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>My method for figuring out a good list of holidays to use is pretty simple: just examine residuals until there aren’t any holiday effects in the days with the largest prediction error.</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="hurricane-impact-valuation.html#cb60-1" aria-hidden="true" tabindex="-1"></a>dat[</span>
<span id="cb60-2"><a href="hurricane-impact-valuation.html#cb60-2" aria-hidden="true" tabindex="-1"></a>  ,</span>
<span id="cb60-3"><a href="hurricane-impact-valuation.html#cb60-3" aria-hidden="true" tabindex="-1"></a>  yhat <span class="sc">:</span><span class="er">=</span> <span class="fu">as.vector</span>(<span class="fu">predict</span>(m_init, <span class="at">type =</span> <span class="st">&#39;response&#39;</span>))</span>
<span id="cb60-4"><a href="hurricane-impact-valuation.html#cb60-4" aria-hidden="true" tabindex="-1"></a>][</span>
<span id="cb60-5"><a href="hurricane-impact-valuation.html#cb60-5" aria-hidden="true" tabindex="-1"></a>  ,</span>
<span id="cb60-6"><a href="hurricane-impact-valuation.html#cb60-6" aria-hidden="true" tabindex="-1"></a>  err <span class="sc">:</span><span class="er">=</span> y <span class="sc">-</span> yhat</span>
<span id="cb60-7"><a href="hurricane-impact-valuation.html#cb60-7" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb60-8"><a href="hurricane-impact-valuation.html#cb60-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-9"><a href="hurricane-impact-valuation.html#cb60-9" aria-hidden="true" tabindex="-1"></a>dat[<span class="fu">order</span>(<span class="sc">-</span><span class="fu">abs</span>(err)), .(ds, hol, err)][<span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>, ]</span></code></pre></div>
<pre><code>##             ds                      hol       err
##  1: 2021-02-16                     none -35.27132
##  2: 2021-02-17                     none -34.25963
##  3: 2021-02-15           Presidents Day -33.54259
##  4: 2019-11-29                     none -30.68251
##  5: 2018-12-24                     none -30.16144
##  6: 2021-02-18                     none -28.81933
##  7: 2022-12-20                     none -26.41082
##  8: 2019-12-24                     none -25.93548
##  9: 2019-11-22 Thanksgiving - Day After  25.91863
## 10: 2022-12-21                     none -25.89014
## 11: 2020-12-24                     none -25.42490
## 12: 2022-02-03                     none -24.04580
## 13: 2022-12-19                     none -23.14676
## 14: 2022-02-04                     none -19.43623
## 15: 2021-02-19                     none -17.49539
## 16: 2018-01-16                     none -17.16050
## 17: 2022-12-16                     none -14.53009
## 18: 2018-12-31                     none -14.31273
## 19: 2022-02-24                     none -13.16629
## 20: 2022-12-15                     none -12.12472</code></pre>
<p>There’s actually a pattern in the residuals that I forgot about: Winter Storm Uri, the unofficial name for the ice storms that hit Texas in 2021.
We’ll add a term for that below.
As for holidays, the main potential that jumps out at me right now is effects related to Christmas Eve, so let’s examine that more closely.</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb62-1"><a href="hurricane-impact-valuation.html#cb62-1" aria-hidden="true" tabindex="-1"></a>lbls <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">paste0</span>(<span class="dv">12</span>, <span class="dv">16</span><span class="sc">:</span><span class="dv">31</span>), <span class="fu">paste0</span>(<span class="st">&#39;01&#39;</span>, <span class="dv">0</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>))</span>
<span id="cb62-2"><a href="hurricane-impact-valuation.html#cb62-2" aria-hidden="true" tabindex="-1"></a>pdat <span class="ot">&lt;-</span> dat[</span>
<span id="cb62-3"><a href="hurricane-impact-valuation.html#cb62-3" aria-hidden="true" tabindex="-1"></a>  ,</span>
<span id="cb62-4"><a href="hurricane-impact-valuation.html#cb62-4" aria-hidden="true" tabindex="-1"></a>  .(<span class="at">day =</span> <span class="fu">strftime</span>(ds, <span class="st">&#39;%m%d&#39;</span>), <span class="at">yr =</span> <span class="fu">year</span>(ds) <span class="sc">+</span> (<span class="fu">month</span>(ds) <span class="sc">==</span> <span class="dv">12</span>),</span>
<span id="cb62-5"><a href="hurricane-impact-valuation.html#cb62-5" aria-hidden="true" tabindex="-1"></a>    wkdy, err)</span>
<span id="cb62-6"><a href="hurricane-impact-valuation.html#cb62-6" aria-hidden="true" tabindex="-1"></a>][</span>
<span id="cb62-7"><a href="hurricane-impact-valuation.html#cb62-7" aria-hidden="true" tabindex="-1"></a>  .(lbls),</span>
<span id="cb62-8"><a href="hurricane-impact-valuation.html#cb62-8" aria-hidden="true" tabindex="-1"></a>  on <span class="ot">=</span> <span class="st">&#39;day&#39;</span></span>
<span id="cb62-9"><a href="hurricane-impact-valuation.html#cb62-9" aria-hidden="true" tabindex="-1"></a>][</span>
<span id="cb62-10"><a href="hurricane-impact-valuation.html#cb62-10" aria-hidden="true" tabindex="-1"></a>  ,</span>
<span id="cb62-11"><a href="hurricane-impact-valuation.html#cb62-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb62-12"><a href="hurricane-impact-valuation.html#cb62-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">yr =</span> <span class="fu">factor</span>(yr),</span>
<span id="cb62-13"><a href="hurricane-impact-valuation.html#cb62-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">day =</span> <span class="fu">factor</span>(day, <span class="at">levels =</span> lbls)</span>
<span id="cb62-14"><a href="hurricane-impact-valuation.html#cb62-14" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb62-15"><a href="hurricane-impact-valuation.html#cb62-15" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb62-16"><a href="hurricane-impact-valuation.html#cb62-16" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(pdat) <span class="sc">+</span></span>
<span id="cb62-17"><a href="hurricane-impact-valuation.html#cb62-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(</span>
<span id="cb62-18"><a href="hurricane-impact-valuation.html#cb62-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(day, err, <span class="at">group =</span> wkdy, <span class="at">fill =</span> wkdy),</span>
<span id="cb62-19"><a href="hurricane-impact-valuation.html#cb62-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">stat =</span> <span class="st">&#39;identity&#39;</span></span>
<span id="cb62-20"><a href="hurricane-impact-valuation.html#cb62-20" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb62-21"><a href="hurricane-impact-valuation.html#cb62-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(yr <span class="sc">~</span>.) <span class="sc">+</span></span>
<span id="cb62-22"><a href="hurricane-impact-valuation.html#cb62-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_discrete_optum</span>(<span class="st">&#39;fill&#39;</span>) <span class="sc">+</span></span>
<span id="cb62-23"><a href="hurricane-impact-valuation.html#cb62-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb62-24"><a href="hurricane-impact-valuation.html#cb62-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&#39;Christmas and New Year</span><span class="sc">\&#39;</span><span class="st">s&#39;</span>,</span>
<span id="cb62-25"><a href="hurricane-impact-valuation.html#cb62-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb62-26"><a href="hurricane-impact-valuation.html#cb62-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">&#39;Utilization&#39;</span>,</span>
<span id="cb62-27"><a href="hurricane-impact-valuation.html#cb62-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="st">&#39;Weekday&#39;</span></span>
<span id="cb62-28"><a href="hurricane-impact-valuation.html#cb62-28" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb62-29"><a href="hurricane-impact-valuation.html#cb62-29" aria-hidden="true" tabindex="-1"></a>  mytheme <span class="sc">+</span></span>
<span id="cb62-30"><a href="hurricane-impact-valuation.html#cb62-30" aria-hidden="true" tabindex="-1"></a>  theme_rotx</span></code></pre></div>
<p><img src="gams-for-actuaries_files/figure-html/unnamed-chunk-53-1.png" width="672" /></p>
<p>Chistmas Eve and New Year’s Eve appear to be exhibiting what I call “bridge effects:” the days only seem to have slowdowns when they create a four-day weekend along with the main holiday.
Independence Day also displayed a similar pattern.
I will skip straight to the final holiday list, but you would keep iterating on fitting models and examining the residuals to add more holiday or other outlier terms.</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="hurricane-impact-valuation.html#cb63-1" aria-hidden="true" tabindex="-1"></a>dat[, hol <span class="sc">:</span><span class="er">=</span> <span class="cn">NULL</span>]</span>
<span id="cb63-2"><a href="hurricane-impact-valuation.html#cb63-2" aria-hidden="true" tabindex="-1"></a>hols <span class="ot">&lt;-</span> <span class="fu">fread</span>(</span>
<span id="cb63-3"><a href="hurricane-impact-valuation.html#cb63-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">file =</span> <span class="fu">file.path</span>(<span class="st">&#39;data&#39;</span>, <span class="st">&#39;hols.csv&#39;</span>),</span>
<span id="cb63-4"><a href="hurricane-impact-valuation.html#cb63-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">colClasses =</span> <span class="fu">c</span>(<span class="at">ds =</span> <span class="st">&#39;character&#39;</span>)</span>
<span id="cb63-5"><a href="hurricane-impact-valuation.html#cb63-5" aria-hidden="true" tabindex="-1"></a>)[</span>
<span id="cb63-6"><a href="hurricane-impact-valuation.html#cb63-6" aria-hidden="true" tabindex="-1"></a>  ,</span>
<span id="cb63-7"><a href="hurricane-impact-valuation.html#cb63-7" aria-hidden="true" tabindex="-1"></a>  ds <span class="sc">:</span><span class="er">=</span> <span class="fu">as.Date</span>(ds)</span>
<span id="cb63-8"><a href="hurricane-impact-valuation.html#cb63-8" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb63-9"><a href="hurricane-impact-valuation.html#cb63-9" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> hols[dat, on <span class="ot">=</span> <span class="st">&#39;ds&#39;</span>]</span>
<span id="cb63-10"><a href="hurricane-impact-valuation.html#cb63-10" aria-hidden="true" tabindex="-1"></a>dat[<span class="fu">is.na</span>(hol), hol <span class="sc">:</span><span class="er">=</span> <span class="st">&#39;none&#39;</span>]</span>
<span id="cb63-11"><a href="hurricane-impact-valuation.html#cb63-11" aria-hidden="true" tabindex="-1"></a>dat[, hol <span class="sc">:</span><span class="er">=</span> <span class="fu">relevel</span>(<span class="fu">factor</span>(hol), <span class="at">ref =</span> <span class="st">&#39;none&#39;</span>)]</span></code></pre></div>
</div>
<div id="hurricane-effect-window" class="section level3 hasAnchor" number="3.3.3">
<h3><span class="header-section-number">3.3.3</span> Hurricane Effect Window<a href="hurricane-impact-valuation.html#hurricane-effect-window" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The last thing we need to do with out initial model is figure out a good effect window to assume for the hurricane.
I do this in a similar way to creating the holiday list, by examining initial model residuals around landfall.</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb64-1"><a href="hurricane-impact-valuation.html#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(dat) <span class="sc">+</span></span>
<span id="cb64-2"><a href="hurricane-impact-valuation.html#cb64-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> landfall, <span class="at">linetype =</span> <span class="st">&#39;dashed&#39;</span>) <span class="sc">+</span></span>
<span id="cb64-3"><a href="hurricane-impact-valuation.html#cb64-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="fu">aes</span>(ds, err, <span class="at">fill =</span> wkdy), <span class="at">stat =</span> <span class="st">&#39;identity&#39;</span>) <span class="sc">+</span></span>
<span id="cb64-4"><a href="hurricane-impact-valuation.html#cb64-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_discrete_optum</span>(<span class="st">&#39;fill&#39;</span>) <span class="sc">+</span></span>
<span id="cb64-5"><a href="hurricane-impact-valuation.html#cb64-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> landfall <span class="sc">+</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">21</span>, <span class="dv">21</span>)) <span class="sc">+</span></span>
<span id="cb64-6"><a href="hurricane-impact-valuation.html#cb64-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb64-7"><a href="hurricane-impact-valuation.html#cb64-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&#39;Initial Model Residuals Near Landfall&#39;</span>,</span>
<span id="cb64-8"><a href="hurricane-impact-valuation.html#cb64-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb64-9"><a href="hurricane-impact-valuation.html#cb64-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb64-10"><a href="hurricane-impact-valuation.html#cb64-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">fill =</span> <span class="fu">element_blank</span>()</span>
<span id="cb64-11"><a href="hurricane-impact-valuation.html#cb64-11" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb64-12"><a href="hurricane-impact-valuation.html#cb64-12" aria-hidden="true" tabindex="-1"></a>  mytheme</span></code></pre></div>
<p><img src="gams-for-actuaries_files/figure-html/unnamed-chunk-55-1.png" width="672" /></p>
<p>Like with holidays, I’m going to skip to using the window I already derived at work.
To do it on your own, you would iterate through fitting a model with a potential hurricane window, examining the estimated smooth to make sure it’s reasonable, and examining the prediction errors around landfall for that model.</p>
</div>
<div id="penultimate-model" class="section level3 hasAnchor" number="3.3.4">
<h3><span class="header-section-number">3.3.4</span> Penultimate Model<a href="hurricane-impact-valuation.html#penultimate-model" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>After the above process is done, we have a specification for all of the outliers and interventions we need for the penultimate, or next to last, model.</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="hurricane-impact-valuation.html#cb65-1" aria-hidden="true" tabindex="-1"></a>dat[, uri <span class="sc">:</span><span class="er">=</span> 0L]</span>
<span id="cb65-2"><a href="hurricane-impact-valuation.html#cb65-2" aria-hidden="true" tabindex="-1"></a>dat[</span>
<span id="cb65-3"><a href="hurricane-impact-valuation.html#cb65-3" aria-hidden="true" tabindex="-1"></a>  .(<span class="fu">seq</span>(<span class="at">from =</span> <span class="fu">as.Date</span>(<span class="st">&#39;2021-2-14&#39;</span>), <span class="at">length.out =</span> <span class="dv">7</span>, <span class="at">by =</span> <span class="dv">1</span>)),</span>
<span id="cb65-4"><a href="hurricane-impact-valuation.html#cb65-4" aria-hidden="true" tabindex="-1"></a>  uri <span class="sc">:</span><span class="er">=</span> .I,</span>
<span id="cb65-5"><a href="hurricane-impact-valuation.html#cb65-5" aria-hidden="true" tabindex="-1"></a>  on <span class="ot">=</span> <span class="st">&#39;ds&#39;</span></span>
<span id="cb65-6"><a href="hurricane-impact-valuation.html#cb65-6" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb65-7"><a href="hurricane-impact-valuation.html#cb65-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-8"><a href="hurricane-impact-valuation.html#cb65-8" aria-hidden="true" tabindex="-1"></a>dat[, harvey <span class="sc">:</span><span class="er">=</span> 0L]</span>
<span id="cb65-9"><a href="hurricane-impact-valuation.html#cb65-9" aria-hidden="true" tabindex="-1"></a>dat[</span>
<span id="cb65-10"><a href="hurricane-impact-valuation.html#cb65-10" aria-hidden="true" tabindex="-1"></a>  .(<span class="fu">seq</span>(<span class="at">from =</span> landfall <span class="sc">-</span> <span class="dv">2</span>, <span class="at">length.out =</span> <span class="dv">21</span>, <span class="at">by =</span> <span class="dv">1</span>)),</span>
<span id="cb65-11"><a href="hurricane-impact-valuation.html#cb65-11" aria-hidden="true" tabindex="-1"></a>  harvey <span class="sc">:</span><span class="er">=</span> .I,</span>
<span id="cb65-12"><a href="hurricane-impact-valuation.html#cb65-12" aria-hidden="true" tabindex="-1"></a>  on <span class="ot">=</span> <span class="st">&#39;ds&#39;</span></span>
<span id="cb65-13"><a href="hurricane-impact-valuation.html#cb65-13" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb65-14"><a href="hurricane-impact-valuation.html#cb65-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-15"><a href="hurricane-impact-valuation.html#cb65-15" aria-hidden="true" tabindex="-1"></a>m_penult <span class="ot">&lt;-</span> <span class="fu">gam</span>(</span>
<span id="cb65-16"><a href="hurricane-impact-valuation.html#cb65-16" aria-hidden="true" tabindex="-1"></a>  y <span class="sc">~</span> <span class="fu">s</span>(t) <span class="sc">+</span> <span class="fu">s</span>(yrfrac) <span class="sc">+</span> <span class="fu">s</span>(covid, <span class="at">k =</span> <span class="dv">122</span> <span class="sc">/</span> <span class="dv">7</span>) <span class="sc">+</span> <span class="fu">s</span>(uri, <span class="at">k =</span> <span class="dv">7</span>)</span>
<span id="cb65-17"><a href="hurricane-impact-valuation.html#cb65-17" aria-hidden="true" tabindex="-1"></a>      <span class="sc">+</span> <span class="fu">s</span>(harvey, <span class="at">k =</span> <span class="dv">21</span>) <span class="sc">+</span> wkdy <span class="sc">+</span> hol,</span>
<span id="cb65-18"><a href="hurricane-impact-valuation.html#cb65-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="fu">gaussian</span>(<span class="at">link =</span> <span class="st">&#39;log&#39;</span>),</span>
<span id="cb65-19"><a href="hurricane-impact-valuation.html#cb65-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> dat,</span>
<span id="cb65-20"><a href="hurricane-impact-valuation.html#cb65-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">knots =</span> <span class="fu">list</span>(<span class="at">t =</span> ts)</span>
<span id="cb65-21"><a href="hurricane-impact-valuation.html#cb65-21" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## Warning in mgcv::s(covid, k = 122/7): argument k of s() should be integer
## and has been rounded</code></pre>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="hurricane-impact-valuation.html#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m_penult)</span></code></pre></div>
<pre><code>## 
## Family: gaussian 
## Link function: log 
## 
## Formula:
## y ~ s(t) + s(yrfrac) + s(covid, k = 122/7) + s(uri, k = 7) + 
##     s(harvey, k = 21) + wkdy + hol
## 
## Parametric coefficients:
##                                   Estimate Std. Error  t value Pr(&gt;|t|)
## (Intercept)                       3.785078   0.003034 1247.446  &lt; 2e-16
## wkdyT                            -0.033896   0.004243   -7.988 2.23e-15
## wkdyW                            -0.065864   0.004336  -15.189  &lt; 2e-16
## wkdyTr                           -0.070122   0.004346  -16.137  &lt; 2e-16
## wkdyF                            -0.185418   0.004637  -39.984  &lt; 2e-16
## wkdySat                          -1.835358   0.018280 -100.403  &lt; 2e-16
## wkdySun                          -2.395776   0.031691  -75.599  &lt; 2e-16
## holChristmas                     -2.390926   0.269866   -8.860  &lt; 2e-16
## holChristmas - Day After         -0.289921   0.042223   -6.866 8.61e-12
## holChristmas Eve                 -1.191191   0.099507  -11.971  &lt; 2e-16
## holIndependence Day              -1.933519   0.159968  -12.087  &lt; 2e-16
## holIndependence Day - Bridge Day -0.298177   0.056288   -5.297 1.30e-07
## holLabor Day                     -2.264282   0.192997  -11.732  &lt; 2e-16
## holMemorial Day                  -2.265312   0.209980  -10.788  &lt; 2e-16
## holNew Year&#39;s                    -1.848559   0.138372  -13.359  &lt; 2e-16
## holNew Year&#39;s - Day After        -0.142470   0.036071   -3.950 8.08e-05
## holNew Year&#39;s Eve                -0.434925   0.048754   -8.921  &lt; 2e-16
## holPresidents Day                 0.012921   0.022767    0.568     0.57
## holThanksgiving                  -2.770453   0.335150   -8.266 2.40e-16
## holThanksgiving - Day After      -0.958753   0.061687  -15.542  &lt; 2e-16
## holThanksgiving - Day Before     -0.177955   0.025493   -6.981 3.91e-12
##                                     
## (Intercept)                      ***
## wkdyT                            ***
## wkdyW                            ***
## wkdyTr                           ***
## wkdyF                            ***
## wkdySat                          ***
## wkdySun                          ***
## holChristmas                     ***
## holChristmas - Day After         ***
## holChristmas Eve                 ***
## holIndependence Day              ***
## holIndependence Day - Bridge Day ***
## holLabor Day                     ***
## holMemorial Day                  ***
## holNew Year&#39;s                    ***
## holNew Year&#39;s - Day After        ***
## holNew Year&#39;s Eve                ***
## holPresidents Day                   
## holThanksgiving                  ***
## holThanksgiving - Day After      ***
## holThanksgiving - Day Before     ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Approximate significance of smooth terms:
##             edf Ref.df      F p-value    
## s(t)      8.979  9.000 129.33  &lt;2e-16 ***
## s(yrfrac) 8.673  8.969 117.04  &lt;2e-16 ***
## s(covid)  9.305 11.236  95.60  &lt;2e-16 ***
## s(uri)    3.058  3.675  52.66  &lt;2e-16 ***
## s(harvey) 4.310  5.250  10.56  &lt;2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## R-sq.(adj) =  0.983   Deviance explained = 98.3%
## GCV = 5.2655  Scale est. = 5.132     n = 2181</code></pre>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb69-1"><a href="hurricane-impact-valuation.html#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(m_penult, <span class="at">pages =</span> <span class="dv">1</span>)</span></code></pre></div>
<p><img src="gams-for-actuaries_files/figure-html/unnamed-chunk-57-1.png" width="672" /></p>
<p>From a quick look at <code>summary()</code> and <code>plot()</code>, it looks like our model is on the right track.
There are two things we need to test for and correct before we can make valid statistical deductions from the model, however.</p>
</div>
<div id="serial-autocorrelation-of-errors" class="section level3 hasAnchor" number="3.3.5">
<h3><span class="header-section-number">3.3.5</span> Serial Autocorrelation of Errors<a href="hurricane-impact-valuation.html#serial-autocorrelation-of-errors" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Since we are working with time series data, observations are correlated through time.
A regression model cannot have any serial autocorrelation of errors, however, because the standard errors of the estimated coefficients will be too small.
We check for serial autocorrelation using ACF and PACF plots.</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb70-1"><a href="hurricane-impact-valuation.html#cb70-1" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">residuals</span>(m_penult, <span class="at">type =</span> <span class="st">&#39;response&#39;</span>)</span>
<span id="cb70-2"><a href="hurricane-impact-valuation.html#cb70-2" aria-hidden="true" tabindex="-1"></a>sig_color <span class="ot">&lt;-</span> colors<span class="sc">$</span>Visualization<span class="sc">$</span>Iris</span>
<span id="cb70-3"><a href="hurricane-impact-valuation.html#cb70-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-4"><a href="hurricane-impact-valuation.html#cb70-4" aria-hidden="true" tabindex="-1"></a>myacf <span class="ot">&lt;-</span> <span class="fu">acf</span>(res, <span class="at">plot =</span> F)</span>
<span id="cb70-5"><a href="hurricane-impact-valuation.html#cb70-5" aria-hidden="true" tabindex="-1"></a>ci <span class="ot">&lt;-</span> <span class="fu">qnorm</span>(.<span class="dv">975</span>)<span class="sc">/</span><span class="fu">sqrt</span>(myacf<span class="sc">$</span>n.used)</span>
<span id="cb70-6"><a href="hurricane-impact-valuation.html#cb70-6" aria-hidden="true" tabindex="-1"></a>pdat <span class="ot">&lt;-</span> <span class="fu">with</span>(</span>
<span id="cb70-7"><a href="hurricane-impact-valuation.html#cb70-7" aria-hidden="true" tabindex="-1"></a>  myacf,</span>
<span id="cb70-8"><a href="hurricane-impact-valuation.html#cb70-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.table</span>(<span class="at">lag =</span> <span class="fu">as.vector</span>(lag), <span class="at">acf =</span> <span class="fu">as.vector</span>(acf))</span>
<span id="cb70-9"><a href="hurricane-impact-valuation.html#cb70-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb70-10"><a href="hurricane-impact-valuation.html#cb70-10" aria-hidden="true" tabindex="-1"></a>pdat[lag <span class="sc">==</span> <span class="dv">0</span>, acf <span class="sc">:</span><span class="er">=</span> <span class="dv">0</span>]</span>
<span id="cb70-11"><a href="hurricane-impact-valuation.html#cb70-11" aria-hidden="true" tabindex="-1"></a>myacf <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(pdat, <span class="fu">aes</span>(<span class="at">x =</span> lag, <span class="at">y =</span> acf)) <span class="sc">+</span></span>
<span id="cb70-12"><a href="hurricane-impact-valuation.html#cb70-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="fu">aes</span>(<span class="at">yintercept =</span> <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb70-13"><a href="hurricane-impact-valuation.html#cb70-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_segment</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">xend =</span> lag, <span class="at">yend =</span> <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb70-14"><a href="hurricane-impact-valuation.html#cb70-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&#39;Lag&#39;</span>, <span class="at">y =</span> <span class="st">&#39;ACF&#39;</span>) <span class="sc">+</span></span>
<span id="cb70-15"><a href="hurricane-impact-valuation.html#cb70-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(</span>
<span id="cb70-16"><a href="hurricane-impact-valuation.html#cb70-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">yintercept =</span> <span class="sc">-</span>ci),</span>
<span id="cb70-17"><a href="hurricane-impact-valuation.html#cb70-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">linetype =</span> <span class="st">&#39;dashed&#39;</span>,</span>
<span id="cb70-18"><a href="hurricane-impact-valuation.html#cb70-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> sig_color</span>
<span id="cb70-19"><a href="hurricane-impact-valuation.html#cb70-19" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb70-20"><a href="hurricane-impact-valuation.html#cb70-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(</span>
<span id="cb70-21"><a href="hurricane-impact-valuation.html#cb70-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">yintercept =</span> ci),</span>
<span id="cb70-22"><a href="hurricane-impact-valuation.html#cb70-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">linetype =</span> <span class="st">&#39;dashed&#39;</span>,</span>
<span id="cb70-23"><a href="hurricane-impact-valuation.html#cb70-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> sig_color</span>
<span id="cb70-24"><a href="hurricane-impact-valuation.html#cb70-24" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb70-25"><a href="hurricane-impact-valuation.html#cb70-25" aria-hidden="true" tabindex="-1"></a>  mytheme</span>
<span id="cb70-26"><a href="hurricane-impact-valuation.html#cb70-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-27"><a href="hurricane-impact-valuation.html#cb70-27" aria-hidden="true" tabindex="-1"></a>mypacf <span class="ot">&lt;-</span> <span class="fu">pacf</span>(res, <span class="at">plot =</span> F)</span>
<span id="cb70-28"><a href="hurricane-impact-valuation.html#cb70-28" aria-hidden="true" tabindex="-1"></a>ci <span class="ot">&lt;-</span> <span class="fu">qnorm</span>(.<span class="dv">975</span>)<span class="sc">/</span><span class="fu">sqrt</span>(mypacf<span class="sc">$</span>n.used)</span>
<span id="cb70-29"><a href="hurricane-impact-valuation.html#cb70-29" aria-hidden="true" tabindex="-1"></a>pdat <span class="ot">&lt;-</span> <span class="fu">with</span>(</span>
<span id="cb70-30"><a href="hurricane-impact-valuation.html#cb70-30" aria-hidden="true" tabindex="-1"></a>  mypacf,</span>
<span id="cb70-31"><a href="hurricane-impact-valuation.html#cb70-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.table</span>(<span class="at">lag =</span> <span class="fu">as.vector</span>(lag), <span class="at">acf =</span> <span class="fu">as.vector</span>(acf))</span>
<span id="cb70-32"><a href="hurricane-impact-valuation.html#cb70-32" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb70-33"><a href="hurricane-impact-valuation.html#cb70-33" aria-hidden="true" tabindex="-1"></a>pdat[lag <span class="sc">==</span> <span class="dv">0</span>, acf <span class="sc">:</span><span class="er">=</span> <span class="dv">0</span>]</span>
<span id="cb70-34"><a href="hurricane-impact-valuation.html#cb70-34" aria-hidden="true" tabindex="-1"></a>mypacf <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(pdat, <span class="fu">aes</span>(<span class="at">x =</span> lag, <span class="at">y =</span> acf)) <span class="sc">+</span></span>
<span id="cb70-35"><a href="hurricane-impact-valuation.html#cb70-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="fu">aes</span>(<span class="at">yintercept =</span> <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb70-36"><a href="hurricane-impact-valuation.html#cb70-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_segment</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">xend =</span> lag, <span class="at">yend =</span> <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb70-37"><a href="hurricane-impact-valuation.html#cb70-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&#39;Lag&#39;</span>, <span class="at">y =</span> <span class="st">&#39;PACF&#39;</span>) <span class="sc">+</span></span>
<span id="cb70-38"><a href="hurricane-impact-valuation.html#cb70-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(</span>
<span id="cb70-39"><a href="hurricane-impact-valuation.html#cb70-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">yintercept =</span> <span class="sc">-</span>ci),</span>
<span id="cb70-40"><a href="hurricane-impact-valuation.html#cb70-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">linetype =</span> <span class="st">&#39;dashed&#39;</span>,</span>
<span id="cb70-41"><a href="hurricane-impact-valuation.html#cb70-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> sig_color</span>
<span id="cb70-42"><a href="hurricane-impact-valuation.html#cb70-42" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb70-43"><a href="hurricane-impact-valuation.html#cb70-43" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(</span>
<span id="cb70-44"><a href="hurricane-impact-valuation.html#cb70-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">yintercept =</span> ci),</span>
<span id="cb70-45"><a href="hurricane-impact-valuation.html#cb70-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">linetype =</span> <span class="st">&#39;dashed&#39;</span>,</span>
<span id="cb70-46"><a href="hurricane-impact-valuation.html#cb70-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> sig_color</span>
<span id="cb70-47"><a href="hurricane-impact-valuation.html#cb70-47" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb70-48"><a href="hurricane-impact-valuation.html#cb70-48" aria-hidden="true" tabindex="-1"></a>  mytheme</span>
<span id="cb70-49"><a href="hurricane-impact-valuation.html#cb70-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-50"><a href="hurricane-impact-valuation.html#cb70-50" aria-hidden="true" tabindex="-1"></a><span class="fu">grid.arrange</span>(</span>
<span id="cb70-51"><a href="hurricane-impact-valuation.html#cb70-51" aria-hidden="true" tabindex="-1"></a>  myacf,</span>
<span id="cb70-52"><a href="hurricane-impact-valuation.html#cb70-52" aria-hidden="true" tabindex="-1"></a>  mypacf,</span>
<span id="cb70-53"><a href="hurricane-impact-valuation.html#cb70-53" aria-hidden="true" tabindex="-1"></a>  <span class="at">ncol =</span> <span class="dv">2</span></span>
<span id="cb70-54"><a href="hurricane-impact-valuation.html#cb70-54" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="gams-for-actuaries_files/figure-html/unnamed-chunk-58-1.png" width="672" /></p>
<p>A valid model will have all of the vertical lines (very close to) within the confidence bands.</p>
</div>
<div id="heteroskedasticity" class="section level3 hasAnchor" number="3.3.6">
<h3><span class="header-section-number">3.3.6</span> Heteroskedasticity<a href="hurricane-impact-valuation.html#heteroskedasticity" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>A regression model must also exhibit <em>homoskedasticity</em>, or have constant error variance.
Violating this assumption not only decreases the standard errors but can also bias coefficient estimates.
The fitting algorithms used by regression models assume that every observation contributes an equal amount of information to coefficient estimation.
Heteroskedasticity entails that the higher-variance regions in the training data contribute less information.</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb71-1"><a href="hurricane-impact-valuation.html#cb71-1" aria-hidden="true" tabindex="-1"></a>wpr <span class="ot">&lt;-</span> <span class="fu">residuals</span>(m_penult, <span class="at">type =</span> <span class="st">&#39;pearson&#39;</span>)</span>
<span id="cb71-2"><a href="hurricane-impact-valuation.html#cb71-2" aria-hidden="true" tabindex="-1"></a>pdat <span class="ot">&lt;-</span> <span class="fu">data.table</span>(</span>
<span id="cb71-3"><a href="hurricane-impact-valuation.html#cb71-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># sqrt standardized Pearson residuals</span></span>
<span id="cb71-4"><a href="hurricane-impact-valuation.html#cb71-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">sspr =</span> <span class="fu">sqrt</span>(<span class="fu">abs</span>(wpr <span class="sc">/</span> <span class="fu">sd</span>(wpr))),</span>
<span id="cb71-5"><a href="hurricane-impact-valuation.html#cb71-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># predictions (on scale of linear predictor)</span></span>
<span id="cb71-6"><a href="hurricane-impact-valuation.html#cb71-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">pred =</span> <span class="fu">predict</span>(m_penult)</span>
<span id="cb71-7"><a href="hurricane-impact-valuation.html#cb71-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb71-8"><a href="hurricane-impact-valuation.html#cb71-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-9"><a href="hurricane-impact-valuation.html#cb71-9" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(pdat, <span class="fu">aes</span>(pred, sspr)) <span class="sc">+</span></span>
<span id="cb71-10"><a href="hurricane-impact-valuation.html#cb71-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb71-11"><a href="hurricane-impact-valuation.html#cb71-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(</span>
<span id="cb71-12"><a href="hurricane-impact-valuation.html#cb71-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> y <span class="sc">~</span> x,</span>
<span id="cb71-13"><a href="hurricane-impact-valuation.html#cb71-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">method =</span> <span class="st">&#39;lm&#39;</span>,</span>
<span id="cb71-14"><a href="hurricane-impact-valuation.html#cb71-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> colors<span class="sc">$</span>Visualization<span class="sc">$</span>Strawberry</span>
<span id="cb71-15"><a href="hurricane-impact-valuation.html#cb71-15" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb71-16"><a href="hurricane-impact-valuation.html#cb71-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb71-17"><a href="hurricane-impact-valuation.html#cb71-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&#39;Scale-Location Plot&#39;</span>,</span>
<span id="cb71-18"><a href="hurricane-impact-valuation.html#cb71-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&#39;Linear Predictor&#39;</span>,</span>
<span id="cb71-19"><a href="hurricane-impact-valuation.html#cb71-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">&#39;Sqrt Std Pearson Residuals&#39;</span></span>
<span id="cb71-20"><a href="hurricane-impact-valuation.html#cb71-20" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb71-21"><a href="hurricane-impact-valuation.html#cb71-21" aria-hidden="true" tabindex="-1"></a>  mytheme</span></code></pre></div>
<p><img src="gams-for-actuaries_files/figure-html/unnamed-chunk-59-1.png" width="672" /></p>
<p>Heteroskedasticity manifests in a scale-location plot as deviations from a flat, straight red line.
A quick way to correct for it is to weight training observations with the errors from the penultimate model.
It would be more elegant to use a priori weights, but I haven’t yet come up with a good algorithm for calculating those for the general utilization dataset.</p>
</div>
<div id="final-model" class="section level3 hasAnchor" number="3.3.7">
<h3><span class="header-section-number">3.3.7</span> Final Model<a href="hurricane-impact-valuation.html#final-model" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>To complete model fitting, we re-fit the penultimate model with an error correlation model to correct for serial autocorrelation and weights to correct for heteroskedasticity.
Unfortunately, the best way I have come up with to correct for serial autocorrelation is very labor-intensive: you have to build a correlation model by hand, eyeballing the coefficients using the ACF and PACF plots.
In general, the lines on the ACF chart tell you the lag-n autocorrelation coefficient, and those on the PACF the moving average coefficient.
They interact with each other in ways that are difficult to predict, however.
I start with the lag 1 and multiples of 7 autoregressive coefficients and go from there.
It is not important to get these estimates exactly right, you just need a good enough correlation model to account for correlated residuals.
We use the <code>gamm()</code> function to pass in a correlation model for the errors and supply a <code>weights</code> argument for heteroskedasticity.</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb72-1"><a href="hurricane-impact-valuation.html#cb72-1" aria-hidden="true" tabindex="-1"></a>wts <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">abs</span>(<span class="fu">residuals</span>(m_penult, <span class="at">type =</span> <span class="st">&#39;scaled.pearson&#39;</span>)))</span></code></pre></div>
<p>The code to fit the model would look like this.</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb73-1"><a href="hurricane-impact-valuation.html#cb73-1" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">c</span>(.<span class="dv">55</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>,</span>
<span id="cb73-2"><a href="hurricane-impact-valuation.html#cb73-2" aria-hidden="true" tabindex="-1"></a>       <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, .<span class="dv">07</span>,</span>
<span id="cb73-3"><a href="hurricane-impact-valuation.html#cb73-3" aria-hidden="true" tabindex="-1"></a>       <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, .<span class="dv">06</span>)</span>
<span id="cb73-4"><a href="hurricane-impact-valuation.html#cb73-4" aria-hidden="true" tabindex="-1"></a>q <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, .<span class="dv">08</span>, <span class="dv">0</span>,</span>
<span id="cb73-5"><a href="hurricane-impact-valuation.html#cb73-5" aria-hidden="true" tabindex="-1"></a>       .<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>,</span>
<span id="cb73-6"><a href="hurricane-impact-valuation.html#cb73-6" aria-hidden="true" tabindex="-1"></a>       <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>,</span>
<span id="cb73-7"><a href="hurricane-impact-valuation.html#cb73-7" aria-hidden="true" tabindex="-1"></a>       <span class="sc">-</span>.<span class="dv">05</span>)</span>
<span id="cb73-8"><a href="hurricane-impact-valuation.html#cb73-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-9"><a href="hurricane-impact-valuation.html#cb73-9" aria-hidden="true" tabindex="-1"></a>m_final <span class="ot">&lt;-</span> <span class="fu">gamm</span>(</span>
<span id="cb73-10"><a href="hurricane-impact-valuation.html#cb73-10" aria-hidden="true" tabindex="-1"></a>  y <span class="sc">~</span> <span class="fu">s</span>(t) <span class="sc">+</span> <span class="fu">s</span>(yrfrac) <span class="sc">+</span> <span class="fu">s</span>(covid, <span class="at">k =</span> <span class="dv">122</span> <span class="sc">/</span> <span class="dv">7</span>) <span class="sc">+</span> <span class="fu">s</span>(uri, <span class="at">k =</span> <span class="dv">7</span>)</span>
<span id="cb73-11"><a href="hurricane-impact-valuation.html#cb73-11" aria-hidden="true" tabindex="-1"></a>      <span class="sc">+</span> <span class="fu">s</span>(harvey, <span class="at">k =</span> <span class="dv">21</span>) <span class="sc">+</span> wkdy <span class="sc">+</span> hol,</span>
<span id="cb73-12"><a href="hurricane-impact-valuation.html#cb73-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> <span class="fu">gaussian</span>(<span class="at">link =</span> <span class="st">&#39;log&#39;</span>),</span>
<span id="cb73-13"><a href="hurricane-impact-valuation.html#cb73-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> dat,</span>
<span id="cb73-14"><a href="hurricane-impact-valuation.html#cb73-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">knots =</span> <span class="fu">list</span>(<span class="at">t =</span> ts),</span>
<span id="cb73-15"><a href="hurricane-impact-valuation.html#cb73-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">correlation =</span> <span class="fu">corARMA</span>(</span>
<span id="cb73-16"><a href="hurricane-impact-valuation.html#cb73-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">value =</span> <span class="fu">c</span>(p, q),</span>
<span id="cb73-17"><a href="hurricane-impact-valuation.html#cb73-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">p =</span> <span class="fu">length</span>(p),</span>
<span id="cb73-18"><a href="hurricane-impact-valuation.html#cb73-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">q =</span> <span class="fu">length</span>(q),</span>
<span id="cb73-19"><a href="hurricane-impact-valuation.html#cb73-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">fixed =</span> T</span>
<span id="cb73-20"><a href="hurricane-impact-valuation.html#cb73-20" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb73-21"><a href="hurricane-impact-valuation.html#cb73-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">weights =</span> wts</span>
<span id="cb73-22"><a href="hurricane-impact-valuation.html#cb73-22" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>Fitting this model took many hours because of all of the modifications we’ve added, so I’ve just cached the fitted model in the <code>data</code> subfolder of our Github repository.</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb74-1"><a href="hurricane-impact-valuation.html#cb74-1" aria-hidden="true" tabindex="-1"></a>m_final <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="at">file =</span> <span class="fu">file.path</span>(<span class="st">&#39;data&#39;</span>, <span class="st">&#39;m_final.RDS&#39;</span>))</span>
<span id="cb74-2"><a href="hurricane-impact-valuation.html#cb74-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m_final<span class="sc">$</span>gam)</span></code></pre></div>
<pre><code>## 
## Family: gaussian 
## Link function: log 
## 
## Formula:
## y ~ s(t) + s(yrfrac) + s(covid, k = 122/7) + s(uri, k = 7) + 
##     s(harvey, k = 21) + wkdy + hol
## 
## Parametric coefficients:
##                                    Estimate Std. Error t value Pr(&gt;|t|)
## (Intercept)                       3.7684028  0.0065583 574.601  &lt; 2e-16
## wkdyT                            -0.0427913  0.0053828  -7.950 3.00e-15
## wkdyW                            -0.0814813  0.0072804 -11.192  &lt; 2e-16
## wkdyTr                           -0.1010531  0.0079996 -12.632  &lt; 2e-16
## wkdyF                            -0.2180938  0.0083694 -26.058  &lt; 2e-16
## wkdySat                          -1.9861325  0.0530410 -37.445  &lt; 2e-16
## wkdySun                          -2.5842627  0.1048317 -24.652  &lt; 2e-16
## holChristmas                     -2.2011358  0.3429394  -6.418 1.69e-10
## holChristmas - Day After         -0.2236717  0.0487236  -4.591 4.68e-06
## holChristmas Eve                 -1.1433660  0.1284091  -8.904  &lt; 2e-16
## holIndependence Day              -1.6876224  0.1300657 -12.975  &lt; 2e-16
## holIndependence Day - Bridge Day -0.2197339  0.0810224  -2.712  0.00674
## holLabor Day                     -2.3877992  0.3534898  -6.755 1.84e-11
## holMemorial Day                  -2.4493897  0.5459640  -4.486 7.63e-06
## holNew Year&#39;s                    -1.6572612  0.1295243 -12.795  &lt; 2e-16
## holNew Year&#39;s - Day After         0.0193896  0.0741909   0.261  0.79385
## holNew Year&#39;s Eve                -0.3398861  0.0580711  -5.853 5.58e-09
## holPresidents Day                 0.0008035  0.0403463   0.020  0.98411
## holThanksgiving                  -0.6035092  0.0947922  -6.367 2.36e-10
## holThanksgiving - Day After      -0.5728268  0.0373162 -15.351  &lt; 2e-16
## holThanksgiving - Day Before     -0.0548677  0.0249713  -2.197  0.02811
##                                     
## (Intercept)                      ***
## wkdyT                            ***
## wkdyW                            ***
## wkdyTr                           ***
## wkdyF                            ***
## wkdySat                          ***
## wkdySun                          ***
## holChristmas                     ***
## holChristmas - Day After         ***
## holChristmas Eve                 ***
## holIndependence Day              ***
## holIndependence Day - Bridge Day ** 
## holLabor Day                     ***
## holMemorial Day                  ***
## holNew Year&#39;s                    ***
## holNew Year&#39;s - Day After           
## holNew Year&#39;s Eve                ***
## holPresidents Day                   
## holThanksgiving                  ***
## holThanksgiving - Day After      ***
## holThanksgiving - Day Before     *  
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Approximate significance of smooth terms:
##             edf Ref.df      F  p-value    
## s(t)      8.874  8.874 40.629  &lt; 2e-16 ***
## s(yrfrac) 7.597  7.597 21.868  &lt; 2e-16 ***
## s(covid)  6.212  6.212 17.103  &lt; 2e-16 ***
## s(uri)    3.092  3.092 11.071 5.53e-07 ***
## s(harvey) 2.505  2.505  4.515   0.0321 *  
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## R-sq.(adj) =  0.923   
##   Scale est. = 11.506    n = 2181</code></pre>
<div class="sourceCode" id="cb76"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb76-1"><a href="hurricane-impact-valuation.html#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(m_final<span class="sc">$</span>gam, <span class="at">pages =</span> <span class="dv">1</span>)</span></code></pre></div>
<p><img src="gams-for-actuaries_files/figure-html/unnamed-chunk-63-1.png" width="672" /></p>
<div class="sourceCode" id="cb77"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb77-1"><a href="hurricane-impact-valuation.html#cb77-1" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">residuals</span>(m_final<span class="sc">$</span>lme, <span class="at">type =</span> <span class="st">&#39;normalized&#39;</span>)</span>
<span id="cb77-2"><a href="hurricane-impact-valuation.html#cb77-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-3"><a href="hurricane-impact-valuation.html#cb77-3" aria-hidden="true" tabindex="-1"></a>myacf <span class="ot">&lt;-</span> <span class="fu">acf</span>(res, <span class="at">plot =</span> F)</span>
<span id="cb77-4"><a href="hurricane-impact-valuation.html#cb77-4" aria-hidden="true" tabindex="-1"></a>ci <span class="ot">&lt;-</span> <span class="fu">qnorm</span>(.<span class="dv">975</span>)<span class="sc">/</span><span class="fu">sqrt</span>(myacf<span class="sc">$</span>n.used)</span>
<span id="cb77-5"><a href="hurricane-impact-valuation.html#cb77-5" aria-hidden="true" tabindex="-1"></a>pdat <span class="ot">&lt;-</span> <span class="fu">with</span>(</span>
<span id="cb77-6"><a href="hurricane-impact-valuation.html#cb77-6" aria-hidden="true" tabindex="-1"></a>  myacf,</span>
<span id="cb77-7"><a href="hurricane-impact-valuation.html#cb77-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.table</span>(<span class="at">lag =</span> <span class="fu">as.vector</span>(lag), <span class="at">acf =</span> <span class="fu">as.vector</span>(acf))</span>
<span id="cb77-8"><a href="hurricane-impact-valuation.html#cb77-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb77-9"><a href="hurricane-impact-valuation.html#cb77-9" aria-hidden="true" tabindex="-1"></a>pdat[lag <span class="sc">==</span> <span class="dv">0</span>, acf <span class="sc">:</span><span class="er">=</span> <span class="dv">0</span>]</span>
<span id="cb77-10"><a href="hurricane-impact-valuation.html#cb77-10" aria-hidden="true" tabindex="-1"></a>myacf <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(pdat, <span class="fu">aes</span>(<span class="at">x =</span> lag, <span class="at">y =</span> acf)) <span class="sc">+</span></span>
<span id="cb77-11"><a href="hurricane-impact-valuation.html#cb77-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="fu">aes</span>(<span class="at">yintercept =</span> <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb77-12"><a href="hurricane-impact-valuation.html#cb77-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_segment</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">xend =</span> lag, <span class="at">yend =</span> <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb77-13"><a href="hurricane-impact-valuation.html#cb77-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&#39;Lag&#39;</span>, <span class="at">y =</span> <span class="st">&#39;ACF&#39;</span>) <span class="sc">+</span></span>
<span id="cb77-14"><a href="hurricane-impact-valuation.html#cb77-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(</span>
<span id="cb77-15"><a href="hurricane-impact-valuation.html#cb77-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">yintercept =</span> <span class="sc">-</span>ci),</span>
<span id="cb77-16"><a href="hurricane-impact-valuation.html#cb77-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">linetype =</span> <span class="st">&#39;dashed&#39;</span>,</span>
<span id="cb77-17"><a href="hurricane-impact-valuation.html#cb77-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> sig_color</span>
<span id="cb77-18"><a href="hurricane-impact-valuation.html#cb77-18" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb77-19"><a href="hurricane-impact-valuation.html#cb77-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(</span>
<span id="cb77-20"><a href="hurricane-impact-valuation.html#cb77-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">yintercept =</span> ci),</span>
<span id="cb77-21"><a href="hurricane-impact-valuation.html#cb77-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">linetype =</span> <span class="st">&#39;dashed&#39;</span>,</span>
<span id="cb77-22"><a href="hurricane-impact-valuation.html#cb77-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> sig_color</span>
<span id="cb77-23"><a href="hurricane-impact-valuation.html#cb77-23" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb77-24"><a href="hurricane-impact-valuation.html#cb77-24" aria-hidden="true" tabindex="-1"></a>  mytheme</span>
<span id="cb77-25"><a href="hurricane-impact-valuation.html#cb77-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-26"><a href="hurricane-impact-valuation.html#cb77-26" aria-hidden="true" tabindex="-1"></a>mypacf <span class="ot">&lt;-</span> <span class="fu">pacf</span>(res, <span class="at">plot =</span> F)</span>
<span id="cb77-27"><a href="hurricane-impact-valuation.html#cb77-27" aria-hidden="true" tabindex="-1"></a>ci <span class="ot">&lt;-</span> <span class="fu">qnorm</span>(.<span class="dv">975</span>)<span class="sc">/</span><span class="fu">sqrt</span>(mypacf<span class="sc">$</span>n.used)</span>
<span id="cb77-28"><a href="hurricane-impact-valuation.html#cb77-28" aria-hidden="true" tabindex="-1"></a>pdat <span class="ot">&lt;-</span> <span class="fu">with</span>(</span>
<span id="cb77-29"><a href="hurricane-impact-valuation.html#cb77-29" aria-hidden="true" tabindex="-1"></a>  mypacf,</span>
<span id="cb77-30"><a href="hurricane-impact-valuation.html#cb77-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.table</span>(<span class="at">lag =</span> <span class="fu">as.vector</span>(lag), <span class="at">acf =</span> <span class="fu">as.vector</span>(acf))</span>
<span id="cb77-31"><a href="hurricane-impact-valuation.html#cb77-31" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb77-32"><a href="hurricane-impact-valuation.html#cb77-32" aria-hidden="true" tabindex="-1"></a>pdat[lag <span class="sc">==</span> <span class="dv">0</span>, acf <span class="sc">:</span><span class="er">=</span> <span class="dv">0</span>]</span>
<span id="cb77-33"><a href="hurricane-impact-valuation.html#cb77-33" aria-hidden="true" tabindex="-1"></a>mypacf <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(pdat, <span class="fu">aes</span>(<span class="at">x =</span> lag, <span class="at">y =</span> acf)) <span class="sc">+</span></span>
<span id="cb77-34"><a href="hurricane-impact-valuation.html#cb77-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="fu">aes</span>(<span class="at">yintercept =</span> <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb77-35"><a href="hurricane-impact-valuation.html#cb77-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_segment</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">xend =</span> lag, <span class="at">yend =</span> <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb77-36"><a href="hurricane-impact-valuation.html#cb77-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&#39;Lag&#39;</span>, <span class="at">y =</span> <span class="st">&#39;PACF&#39;</span>) <span class="sc">+</span></span>
<span id="cb77-37"><a href="hurricane-impact-valuation.html#cb77-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(</span>
<span id="cb77-38"><a href="hurricane-impact-valuation.html#cb77-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">yintercept =</span> <span class="sc">-</span>ci),</span>
<span id="cb77-39"><a href="hurricane-impact-valuation.html#cb77-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">linetype =</span> <span class="st">&#39;dashed&#39;</span>,</span>
<span id="cb77-40"><a href="hurricane-impact-valuation.html#cb77-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> sig_color</span>
<span id="cb77-41"><a href="hurricane-impact-valuation.html#cb77-41" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb77-42"><a href="hurricane-impact-valuation.html#cb77-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(</span>
<span id="cb77-43"><a href="hurricane-impact-valuation.html#cb77-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">yintercept =</span> ci),</span>
<span id="cb77-44"><a href="hurricane-impact-valuation.html#cb77-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">linetype =</span> <span class="st">&#39;dashed&#39;</span>,</span>
<span id="cb77-45"><a href="hurricane-impact-valuation.html#cb77-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> sig_color</span>
<span id="cb77-46"><a href="hurricane-impact-valuation.html#cb77-46" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb77-47"><a href="hurricane-impact-valuation.html#cb77-47" aria-hidden="true" tabindex="-1"></a>  mytheme</span>
<span id="cb77-48"><a href="hurricane-impact-valuation.html#cb77-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-49"><a href="hurricane-impact-valuation.html#cb77-49" aria-hidden="true" tabindex="-1"></a><span class="fu">grid.arrange</span>(</span>
<span id="cb77-50"><a href="hurricane-impact-valuation.html#cb77-50" aria-hidden="true" tabindex="-1"></a>  myacf,</span>
<span id="cb77-51"><a href="hurricane-impact-valuation.html#cb77-51" aria-hidden="true" tabindex="-1"></a>  mypacf,</span>
<span id="cb77-52"><a href="hurricane-impact-valuation.html#cb77-52" aria-hidden="true" tabindex="-1"></a>  <span class="at">ncol =</span> <span class="dv">2</span></span>
<span id="cb77-53"><a href="hurricane-impact-valuation.html#cb77-53" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p><img src="gams-for-actuaries_files/figure-html/unnamed-chunk-64-1.png" width="672" /></p>
<div class="sourceCode" id="cb78"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb78-1"><a href="hurricane-impact-valuation.html#cb78-1" aria-hidden="true" tabindex="-1"></a>wpr <span class="ot">&lt;-</span> <span class="fu">residuals</span>(m_final<span class="sc">$</span>gam, <span class="at">type =</span> <span class="st">&#39;pearson&#39;</span>) <span class="sc">/</span> wts</span>
<span id="cb78-2"><a href="hurricane-impact-valuation.html#cb78-2" aria-hidden="true" tabindex="-1"></a>pdat <span class="ot">&lt;-</span> <span class="fu">data.table</span>(</span>
<span id="cb78-3"><a href="hurricane-impact-valuation.html#cb78-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># sqrt standardized Pearson residuals</span></span>
<span id="cb78-4"><a href="hurricane-impact-valuation.html#cb78-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">sspr =</span> <span class="fu">sqrt</span>(<span class="fu">abs</span>(wpr <span class="sc">/</span> <span class="fu">sd</span>(wpr))),</span>
<span id="cb78-5"><a href="hurricane-impact-valuation.html#cb78-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># predictions (on scale of linear predictor)</span></span>
<span id="cb78-6"><a href="hurricane-impact-valuation.html#cb78-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">pred =</span> <span class="fu">predict</span>(m_penult)</span>
<span id="cb78-7"><a href="hurricane-impact-valuation.html#cb78-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb78-8"><a href="hurricane-impact-valuation.html#cb78-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-9"><a href="hurricane-impact-valuation.html#cb78-9" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(pdat, <span class="fu">aes</span>(pred, sspr)) <span class="sc">+</span></span>
<span id="cb78-10"><a href="hurricane-impact-valuation.html#cb78-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb78-11"><a href="hurricane-impact-valuation.html#cb78-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(</span>
<span id="cb78-12"><a href="hurricane-impact-valuation.html#cb78-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> y <span class="sc">~</span> x,</span>
<span id="cb78-13"><a href="hurricane-impact-valuation.html#cb78-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">method =</span> <span class="st">&#39;lm&#39;</span>,</span>
<span id="cb78-14"><a href="hurricane-impact-valuation.html#cb78-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> colors<span class="sc">$</span>Visualization<span class="sc">$</span>Strawberry</span>
<span id="cb78-15"><a href="hurricane-impact-valuation.html#cb78-15" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb78-16"><a href="hurricane-impact-valuation.html#cb78-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb78-17"><a href="hurricane-impact-valuation.html#cb78-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&#39;Scale-Location Plot&#39;</span>,</span>
<span id="cb78-18"><a href="hurricane-impact-valuation.html#cb78-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">&#39;Linear Predictor&#39;</span>,</span>
<span id="cb78-19"><a href="hurricane-impact-valuation.html#cb78-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">&#39;Sqrt Std Pearson Residuals&#39;</span></span>
<span id="cb78-20"><a href="hurricane-impact-valuation.html#cb78-20" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb78-21"><a href="hurricane-impact-valuation.html#cb78-21" aria-hidden="true" tabindex="-1"></a>  mytheme</span></code></pre></div>
<p><img src="gams-for-actuaries_files/figure-html/unnamed-chunk-65-1.png" width="672" /></p>
<p>We are using the parameters I’ve already come up with, but in reality, we would cycle through examining these four outputs and tweaking model parameters until everything looks good.
This is a time-consuming and sometimes frustrating process!</p>
<p>At the end of all this, however, we have a mathematically-robust estimate of the utilization impact due to Hurricane Harvey.
We can visualize the estimated smooth like this.</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb79-1"><a href="hurricane-impact-valuation.html#cb79-1" aria-hidden="true" tabindex="-1"></a>st <span class="ot">&lt;-</span> dat[harvey <span class="sc">==</span> <span class="dv">1</span>, ds]</span>
<span id="cb79-2"><a href="hurricane-impact-valuation.html#cb79-2" aria-hidden="true" tabindex="-1"></a>pdat <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(</span>
<span id="cb79-3"><a href="hurricane-impact-valuation.html#cb79-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">confint</span>(</span>
<span id="cb79-4"><a href="hurricane-impact-valuation.html#cb79-4" aria-hidden="true" tabindex="-1"></a>    m_final,</span>
<span id="cb79-5"><a href="hurricane-impact-valuation.html#cb79-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">parm =</span> <span class="st">&#39;s(harvey)&#39;</span>,</span>
<span id="cb79-6"><a href="hurricane-impact-valuation.html#cb79-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">type =</span> <span class="st">&#39;confidence&#39;</span></span>
<span id="cb79-7"><a href="hurricane-impact-valuation.html#cb79-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb79-8"><a href="hurricane-impact-valuation.html#cb79-8" aria-hidden="true" tabindex="-1"></a>)[</span>
<span id="cb79-9"><a href="hurricane-impact-valuation.html#cb79-9" aria-hidden="true" tabindex="-1"></a>  ,</span>
<span id="cb79-10"><a href="hurricane-impact-valuation.html#cb79-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb79-11"><a href="hurricane-impact-valuation.html#cb79-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">ind =</span> st <span class="sc">+</span> (dat[, <span class="fu">max</span>(harvey)] <span class="sc">/</span> .N ) <span class="sc">*</span> .I <span class="sc">-</span> <span class="dv">1</span>,</span>
<span id="cb79-12"><a href="hurricane-impact-valuation.html#cb79-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">sig =</span> upper <span class="sc">&lt;</span> <span class="dv">0</span> <span class="sc">|</span> lower <span class="sc">&gt;</span> <span class="dv">0</span></span>
<span id="cb79-13"><a href="hurricane-impact-valuation.html#cb79-13" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb79-14"><a href="hurricane-impact-valuation.html#cb79-14" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb79-15"><a href="hurricane-impact-valuation.html#cb79-15" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(pdat, <span class="at">mapping =</span> <span class="fu">aes</span>(ind)) <span class="sc">+</span></span>
<span id="cb79-16"><a href="hurricane-impact-valuation.html#cb79-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">&#39;dashed&#39;</span>) <span class="sc">+</span></span>
<span id="cb79-17"><a href="hurricane-impact-valuation.html#cb79-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(</span>
<span id="cb79-18"><a href="hurricane-impact-valuation.html#cb79-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">ymin =</span> <span class="fu">exp</span>(lower), <span class="at">ymax =</span> <span class="fu">exp</span>(upper)),</span>
<span id="cb79-19"><a href="hurricane-impact-valuation.html#cb79-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> .<span class="dv">2</span></span>
<span id="cb79-20"><a href="hurricane-impact-valuation.html#cb79-20" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb79-21"><a href="hurricane-impact-valuation.html#cb79-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb79-22"><a href="hurricane-impact-valuation.html#cb79-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">y =</span> <span class="fu">exp</span>(est), <span class="at">group =</span> <span class="dv">1</span>, <span class="at">color =</span> sig),</span>
<span id="cb79-23"><a href="hurricane-impact-valuation.html#cb79-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">linewidth =</span> <span class="dv">2</span>,</span>
<span id="cb79-24"><a href="hurricane-impact-valuation.html#cb79-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">show.legend =</span> F</span>
<span id="cb79-25"><a href="hurricane-impact-valuation.html#cb79-25" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb79-26"><a href="hurricane-impact-valuation.html#cb79-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_discrete_optum</span>(<span class="at">aesthetics =</span> <span class="st">&#39;color&#39;</span>) <span class="sc">+</span></span>
<span id="cb79-27"><a href="hurricane-impact-valuation.html#cb79-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb79-28"><a href="hurricane-impact-valuation.html#cb79-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">&#39;Estimated Hurricane Harvey Impact&#39;</span>,</span>
<span id="cb79-29"><a href="hurricane-impact-valuation.html#cb79-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">&#39;Statistically Significant Areas Colored Red&#39;</span>,</span>
<span id="cb79-30"><a href="hurricane-impact-valuation.html#cb79-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb79-31"><a href="hurricane-impact-valuation.html#cb79-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="fu">element_blank</span>()</span>
<span id="cb79-32"><a href="hurricane-impact-valuation.html#cb79-32" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb79-33"><a href="hurricane-impact-valuation.html#cb79-33" aria-hidden="true" tabindex="-1"></a>  mytheme</span></code></pre></div>
<p><img src="gams-for-actuaries_files/figure-html/unnamed-chunk-66-1.png" width="672" /></p>
</div>
</div>
<div id="using-the-model" class="section level2 hasAnchor" number="3.4">
<h2><span class="header-section-number">3.4</span> Using the Model<a href="hurricane-impact-valuation.html#using-the-model" class="anchor-section" aria-label="Anchor link to header"></a></h2>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="utilization-forecasting.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="valuation-of-care-interventions.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
